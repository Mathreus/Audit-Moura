WITH ClientesMultiplosTND AS (
    SELECT 
        COD_CLIENTE,
        COUNT(DISTINCT NOTA_FISCAL) as qtd_notas_fiscais,
        SUM(VALOR_TITULO) AS VALOR_TOTAL
    FROM 
        VW_AUDIT_RM_TRANSACOES_FECHADAS
    WHERE 
        COD_ESTABELECIMENTO IN ('R291', 'R292')
        AND DATA_TRANSACAO BETWEEN '2025-07-01' AND '2025-12-31'
        AND PERFIL_LANCAMENTO = 'TND'
    GROUP BY 
        COD_CLIENTE
),
TransacoesComContagem AS (
    SELECT
        v.COD_ESTABELECIMENTO,
        v.COD_CLIENTE,    
        v.NOME_CLIENTE,
        v.DATA_TRANSACAO,
        v.DATA_VENCIMENTO,
        v.PERFIL_LANCAMENTO,
        v.NOTA_FISCAL,
        v.COMPROVANTE,
        v.PARCELA,
        v.VALOR_PARCELA,
        v.VALOR_TITULO,
        COUNT(v.NOTA_FISCAL) OVER (PARTITION BY v.COD_CLIENTE, v.NOTA_FISCAL) AS qtd_repeticao_nota
    FROM
        VW_AUDIT_RM_TRANSACOES_FECHADAS v
    INNER JOIN 
        ClientesMultiplosTND c ON v.COD_CLIENTE = c.COD_CLIENTE
    WHERE
        v.COD_ESTABELECIMENTO IN ('R291', 'R292')
        AND v.DATA_TRANSACAO BETWEEN '2025-07-01' AND '2025-12-31'
        AND v.PERFIL_LANCAMENTO = 'TND'
)
SELECT *
FROM TransacoesComContagem
WHERE qtd_repeticao_nota > 1
ORDER BY
    COD_CLIENTE,
    NOTA_FISCAL,
    DATA_TRANSACAO;
